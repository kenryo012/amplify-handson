AWSTemplateFormatVersion: '2010-09-09'
Parameters: 
  # Jsonファイルに出力されていたパラメータを移植
  env:
    Type: String
  apiamplifyhandsonksatou2GraphQLAPIIdOutput:
    Type: String
  apiamplifyhandsonksatou2GraphQLAPIEndpointOutput:
    Type: String
Resources:
  # ステートマシンに付与するIAMロール
  # ステートマシンは現在PassするだけのやつなのでIAMポリシーは適当に付与
  StatesExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - states.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSStepFunctionsFullAccess
  # EventBridge Pipes用のIAMロール
  ApplyPipeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ksatouApplyPipeRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - pipes.amazonaws.com
            Action:
              - sts:AssumeRole
  # EventBridge Pipes用のIAMポリシー
  ApplyPipePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: ksatouApplyPipePolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # DynamoDB Streamsの参照を許可する設定
          - Effect: Allow
            Action:
              - dynamodb:DescribeStream
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:ListStreams
            Resource:
              Fn::ImportValue:
                Fn::Sub: >-
                  ${apiamplifyhandsonksatou2GraphQLAPIIdOutput}:GetAtt:ApplicationTable:StreamArn
          # Step Functionsのステートマシンの実行を許可する設定
          - Effect: Allow
            Action:
              - states:StartExecution
            Resource:
              Fn::GetAtt:
                - IntegrationStateMachine
                - Arn
      Roles:
        - Ref: ApplyPipeRole
  # Step Functionsのステートマシン
  # 動作確認用なのでステートマシンの処理は簡素
  IntegrationStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      DefinitionString: |-
        {
          "Comment": "A description of my state machine",
          "StartAt": "Pass",
          "States": {
            "Pass": {
              "Type": "Pass",
              "End": true
            }
          }
        }
      StateMachineName: ksatou2IntegrationStateMachine
      RoleArn:
        Fn::GetAtt:
          - StatesExecutionRole
          - Arn
  # EventBridge Pipes
  ApplyPipe:
    Type: AWS::Pipes::Pipe
    Properties:
      Name: ksatouApplyPipe
      RoleArn:
        Fn::GetAtt:
          - ApplyPipeRole
          - Arn
      # イベントの元となるリソースのARNを指定
      # 今回はDynamoDB StreamsのARN
      Source:
        Fn::ImportValue:
          Fn::Sub: >-
            ${apiamplifyhandsonksatou2GraphQLAPIIdOutput}:GetAtt:ApplicationTable:StreamArn
      SourceParameters:
        # イベント読み取りに関する設定
        # StartingPositionは読み取り開始位置を意味し、LATESTは常に最新のものから順に読み込むことを表す
        # BatchSizeは1回の読み取りで最大いくつイベントをターゲットに流し込むかを指定する
        DynamoDBStreamParameters:
          StartingPosition: LATEST
          BatchSize: 1
        # イベントのフィルタリング設定
        # イベントJson内にプライマリーキーが存在し、かつ、eventNameの値がINSERTであるもののみ処理するよう指定
        FilterCriteria:
          Filters:
            - Pattern: >-
                {"dynamodb":{"Keys":{"id":{"S":[{"exists":true}]}}},"eventName":[{"prefix":"INSERT"}]}
      # ターゲットとなるリソースのARNを指定
      # 今回はStep FunctionsのステートマシンのARN
      Target:
        Fn::GetAtt:
          - IntegrationStateMachine
          - Arn
      # ターゲットに関する設定
      # ステートマシンのワークフロータイプが標準（デフォルト）の場合、非同期実行（FIRE_AND_FORGET）を指定しなければならない
      # https://docs.aws.amazon.com/eventbridge/latest/pipes-reference/API_PipeTargetStateMachineParameters.html
      TargetParameters:
        StepFunctionStateMachineParameters:
          InvocationType: FIRE_AND_FORGET
Description: >-
  {"createdOn":"Mac","createdBy":"Amplify","createdWith":"12.8.2","stackType":"custom-customCloudformation","metadata":{}}
